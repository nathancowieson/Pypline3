import os.path
import yaml

from visit_id import VisitID
from poll_directory import PollFileSystem
from database import Database
from logger import myLogger
from nxs import ParseNXS
from raw_dat import RawDat
from dat_manager import DatManager

#START A LOG FILE
log = myLogger(os.path.basename(__file__))

#GET THE CONFIG FILE
pypline_dir = os.path.dirname(os.path.realpath(__file__))
with open(pypline_dir+'/config.yaml', 'r') as ymlfile:
    myconfig = yaml.load(ymlfile)

#CONNECT TO THE SQLITE DATABASE
database = Database()

if not os.path.isfile(myconfig['setup']['database']):
    log.info('no database found, starting a new one')
    database.createDatabase()

#DEFINE THE VISIT
visit = VisitID('sw14620-1')
visit.MakeOutputDirs()

#A VARIABLE FOR MAKING DECISIONS ABOUT ROBOT BUFFERS
previous_scan_type = None

#MAKE A VISIT ENTRY IN THE DATABASE IF ITS NOT THERE ALREADY
if not visit.ReturnVisitID() in database.ReturnVisits():
    log.info('Entered visit: '+visit.ReturnVisitID()+' to the database')
    database.insertData(visit.ReturnSQLDict())#database the visit

#CONNECT TO THE FILE SYSTEM
files = PollFileSystem(visit)

#AN OBJECT TO HANDLE AVERAGING AND SUBTRACTING
dat_manager = DatManager()

#PARSE THE NEW NXS FILES
for nxsfile in sorted( list( set(files.ReturnNxsFiles()) - set(database.ReturnVisitNxsFiles(visit)) ) )[4:10]:
    parsednxs = ParseNXS(database, visit, nxsfile)
    database.insertData(parsednxs.ReturnSQLDict('nxs'))
    if parsednxs.WaitForDatFiles():
        for datfile in parsednxs.ReturnDatFiles():
            parsednxs.AddDatData(RawDat(datfile))
            database.SaveDatFile(parsednxs.dat_data[-1].OutputDatDictForFile())       # save and database the raw
            database.insertData(parsednxs.ReturnSQLDict(datfile))                     # individual dat files
        kind_of_sample = dat_manager.AddParsedNXS(parsednxs)
        if kind_of_sample == 'new buffer':
            log.info('New buffer detected, flushed old buffers and samples')
        elif kind_of_sample == 'repeat robot buffer':
            log.info('found a repeat robot buffer')
            #average the buffers
            av_buffer = dat_manager.AverageDatFiles('buffers')#average the buffers
            database.insertData(av_buffer[1])
            database.SaveDatFile(av_buffer[0])
            #average the samples
            av_sample = dat_manager.AverageDatFiles('samples')#average the buffers
            database.insertData(av_buffer[1])
            database.SaveDatFile(av_buffer[0])
            #subtract each sample in memory
        elif kind_of_sample == 'new robot sample':
            log.info('found a robot sample')
            #average the buffers
            av_buffer = dat_manager.AverageDatFiles('buffers')#average the buffers
            database.insertData(av_buffer[1])
            database.SaveDatFile(av_buffer[0])
            #average THIS sample
            av_buffer = dat_manager.AverageDatFiles( dat_manager.samples[-1] )#average THIS sample
            database.insertData(av_buffer[1])
            database.SaveDatFile(av_buffer[0])
            #subtract THIS sample
        elif kind_of_sample == 'repeat sec buffer':
            log.info('Repeat SEC buffer detected, added to buffers in memory')
        elif kind_of_sample == 'non-matching sec buffer':
            log.info('SEC buffer did not match previous SEC buffer, ignoring new one')
        elif kind_of_sample == 'new sec sample':
            log.info('found a new SEC sample')
            #average the buffers
            av_buffer = dat_manager.AverageDatFiles('buffers')#average the buffers
            database.insertData(av_buffer[1])
            database.SaveDatFile(av_buffer[0])
            #subtract EACH INDIVIDUAL dat file in THIS nxs
        elif kind_of_sample == 'manual collection or scan':
            log.info('manual collection or scan detected, will ignore')
        else:
            log.error('AddParsedNXS returned something unexpected')

            
    dat_manager
